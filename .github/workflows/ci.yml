# ==============================================================================
# GitHub Actions CI/CD Workflow for Raku MCP SDK
# ==============================================================================

name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      run_coverage:
        description: 'Run coverage job (slow; currently non-gating)'
        type: choice
        options:
          - 'false'
          - 'true'
        default: 'false'

permissions:
  contents: write

env:
  # Raku version to use
  RAKU_VERSION: '2024.01'
  # Coverage is slow and currently non-gating; keep it off until we enforce a threshold.
  # TODO: Enable coverage and fail CI if coverage drops below an agreed threshold.

jobs:
  # ----------------------------------------------------------------------------
  # Lint Job - Check code quality
  # ----------------------------------------------------------------------------
  lint:
    name: Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Raku
        uses: Raku/setup-raku@v1
        with:
          raku-version: ${{ env.RAKU_VERSION }}

      - name: Cache Raku dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.raku
            ~/.zef
          key: raku-${{ runner.os }}-${{ env.RAKU_VERSION }}-${{ hashFiles('META6.json') }}
          restore-keys: |
            raku-${{ runner.os }}-${{ env.RAKU_VERSION }}-
            raku-${{ runner.os }}-

      - name: Install dependencies
        run: zef install --deps-only . --/test

      - name: Format check
        run: make format

      - name: Validate META6.json
        run: make lint-meta

      - name: Check syntax
        run: make lint-syntax

  # ----------------------------------------------------------------------------
  # Test Job - Run test suite
  # ----------------------------------------------------------------------------
  test:
    name: Test (${{ matrix.os }} / Raku ${{ matrix.raku-version }})
    runs-on: ${{ matrix.os }}
    needs: lint
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        raku-version: ['2024.01', 'latest']
        exclude:
          # Exclude some combinations to reduce CI time
          - os: windows-latest
            raku-version: '2024.01'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Raku
        uses: Raku/setup-raku@v1
        with:
          raku-version: ${{ matrix.raku-version }}

      - name: Cache Raku dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.raku
            ~/.zef
          key: raku-${{ runner.os }}-${{ matrix.raku-version }}-${{ hashFiles('META6.json') }}
          restore-keys: |
            raku-${{ runner.os }}-${{ matrix.raku-version }}-
            raku-${{ runner.os }}-

      - name: Install dependencies
        run: zef install --deps-only . --/test

      - name: Ensure JSON::Fast is installed
        run: zef install JSON::Fast

      - name: Verify Cro::HTTP availability
        run: |
          raku -e 'use Cro::HTTP::Client; use Cro::HTTP::Server; say "Cro::HTTP ok"'

      - name: Run tests
        run: |
          zef install App::Prove6 || true
          prove6 -I. -v t/
        # TODO: Consider a targeted one-time retry for specific flaky tests only.

      - name: Run tests (fallback)
        if: failure()
        run: |
          raku -I. t/01-types.rakutest
          raku -I. t/02-jsonrpc.rakutest

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    needs: test
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_coverage == 'true' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Raku
        uses: Raku/setup-raku@v1
        with:
          raku-version: ${{ env.RAKU_VERSION }}

      - name: Cache Raku dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.raku
            ~/.zef
          key: raku-${{ runner.os }}-${{ env.RAKU_VERSION }}-${{ hashFiles('META6.json') }}
          restore-keys: |
            raku-${{ runner.os }}-${{ env.RAKU_VERSION }}-
            raku-${{ runner.os }}-

      - name: Install dependencies
        run: zef install --deps-only . --/test

      - name: Install RaCoCo
        run: zef install App::RaCoCo

      - name: Generate coverage report
        run: make coverage

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage-report
