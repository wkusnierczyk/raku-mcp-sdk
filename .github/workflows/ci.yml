# ==============================================================================
# GitHub Actions CI/CD Workflow for Raku MCP SDK
# ==============================================================================

name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

env:
  # Raku version to use
  RAKU_VERSION: '2024.12'

jobs:
  # ----------------------------------------------------------------------------
  # Lint Job - Check code quality
  # ----------------------------------------------------------------------------
  lint:
    name: Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Raku
        uses: Raku/setup-raku@v1
        with:
          raku-version: ${{ env.RAKU_VERSION }}

      - name: Cache Raku dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.raku
            ~/.zef
          key: raku-${{ runner.os }}-${{ env.RAKU_VERSION }}-${{ hashFiles('META6.json') }}
          restore-keys: |
            raku-${{ runner.os }}-${{ env.RAKU_VERSION }}-
            raku-${{ runner.os }}-

      - name: Install dependencies
        run: zef install --deps-only . --/test

      - name: Format check
        run: make format

      - name: Validate META6.json
        run: make lint-meta

      - name: Check syntax
        run: make lint-syntax

  # ----------------------------------------------------------------------------
  # Test Job - Run test suite
  # ----------------------------------------------------------------------------
  test:
    name: Test (${{ matrix.os }} / Raku ${{ matrix.raku-version }})
    runs-on: ${{ matrix.os }}
    needs: lint
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        raku-version: ['2024.12', 'latest']
        exclude:
          # Exclude some combinations to reduce CI time
          - os: windows-latest
            raku-version: '2024.12'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Raku
        uses: Raku/setup-raku@v1
        with:
          raku-version: ${{ matrix.raku-version }}

      - name: Cache Raku dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.raku
            ~/.zef
          key: raku-${{ runner.os }}-${{ matrix.raku-version }}-${{ hashFiles('META6.json') }}
          restore-keys: |
            raku-${{ runner.os }}-${{ matrix.raku-version }}-
            raku-${{ runner.os }}-

      - name: Install dependencies
        run: zef install --deps-only . --/test

      - name: Ensure JSON::Fast is installed
        run: zef install JSON::Fast

      - name: Verify Cro::HTTP availability
        run: |
          raku -e 'use Cro::HTTP::Client; use Cro::HTTP::Server; say "Cro::HTTP ok"'

      - name: Run tests
        run: |
          zef install App::Prove6 || true
          prove6 -I. -v t/

  # ----------------------------------------------------------------------------
  # Coverage Job - Generate coverage report and enforce threshold
  # ----------------------------------------------------------------------------
  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Raku
        uses: Raku/setup-raku@v1
        with:
          raku-version: ${{ env.RAKU_VERSION }}

      - name: Cache Raku dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.raku
            ~/.zef
          key: raku-coverage-${{ runner.os }}-${{ env.RAKU_VERSION }}-${{ hashFiles('META6.json') }}
          restore-keys: |
            raku-coverage-${{ runner.os }}-${{ env.RAKU_VERSION }}-
            raku-coverage-${{ runner.os }}-

      - name: Install dependencies
        run: |
          zef install --deps-only . --/test
          zef install App::Prove6 || true
          zef install App::RaCoCo || true

      - name: Generate coverage report and check threshold
        run: |
          THRESHOLD=70
          OUTPUT=$(make coverage 2>&1)
          echo "$OUTPUT"
          COVERAGE=$(echo "$OUTPUT" | grep -oP 'Coverage: \K[0-9.]+' || echo "0")
          echo "Coverage: ${COVERAGE}%" >&2
          echo "Threshold: ${THRESHOLD}%" >&2
          if [ "$(echo "$COVERAGE < $THRESHOLD" | bc -l)" -eq 1 ]; then
            echo "::error::Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
            exit 1
          fi
          echo "âœ“ Coverage ${COVERAGE}% meets threshold ${THRESHOLD}%" >&2

